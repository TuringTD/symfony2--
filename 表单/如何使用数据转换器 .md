[原文地址](http://symfony.com/doc/current/cookbook/form/data_transformers.html) http://symfony.com/doc/current/cookbook/form/data_transformers.html

#如何使用数据转换器

数据转换器是用于把一个字段数据转化成能够在表单中(或提交后的数据)展示的格式,symfony内部有许多字段类型可用,例如,[date](http://symfony.com/doc/current/reference/forms/types/date.html)
字段类型能够渲染一个yyyy-MM-dd格式的输入文本框.内部,一个数据转换器把一个字段的起始DateTime值转化成yyyy-MM-dd字符串格式用于表单渲染
,当表单提交后又转化成一个DateTime对象;

注意:
>当一个表单字段设置了inherit_data选项,数据转换器不应用于该字段

##简单的例子:净化用户输入的HTML

假如你有一个Task表单里有一个描述 textarea 类型的字段

    // src/AppBundle/Form/TaskType.php
    namespace AppBundle\Form\Type;

    use Symfony\Component\Form\FormBuilderInterface;
    use Symfony\Component\OptionsResolver\OptionsResolver;

    // ...
    class TaskType extends AbstractType
    {
        public function buildForm(FormBuilderInterface $builder, array $options)
        {
            $builder->add('description', 'textarea');
        }

        public function configureOptions(OptionsResolver $resolver)
        {
            $resolver->setDefaults(array(
                'data_class' => 'AppBundle\Entity\Task',
            ));
        }

        // ...
    }

但是,这有两个难题:

1. 你允许用户使用一些html标签,而不是所有:你需要一个方式表单提交后调用strip_tags方法
2. 为了友好,你想要在渲染这个字段之前将`<br/>`标签转化成换行符`\n`更好的编辑;

这是一个完美的时间,自定义的数据转换附加到描述字段。最简单的方式使用CallbackTransformer类

    // src/AppBundle/Form/TaskType.php
    namespace AppBundle\Form\Type;

    use Symfony\Component\Form\CallbackTransformer;
    use Symfony\Component\Form\FormBuilderInterface;
    // ...

    class TaskType extends AbstractType
    {
        public function buildForm(FormBuilderInterface $builder, array $options)
        {
            $builder->add('description', 'textarea');

            $builder->get('description')
                ->addModelTransformer(new CallbackTransformer(
                    // <br/>转化成\n
                    function ($originalDescription) {
                        return preg_replace('#<br\s*/?>#i', "\n", $originalDescription);
                    },
                    function ($submittedDescription) {
                        // 移除大部份html(但不包括br,p);
                        $cleaned = strip_tags($submittedDescription, '<br><br/><p>');

                        //转换\n 为br;
                        return str_replace("\n", '<br/>', $cleaned);
                    }
                ))
            ;
        }

        // ...
    }

该CallbackTransformer需要两个回调方法作为参数,第一个是将原数据转化成一个将要用于渲染这个字段的格式
第二个相反,他是将提交后的数据转化成你将要用于你的代码里的格式;

小提示:
>该addModelTransformer()方法接收任何实现了DataTransformerInterface接口的对象-所以你能够
创建你自己的类,而不是在表单里写入所有的逻辑

你也可以通过轻微的改变添加字段的格式来增加数据转换器

    $builder->add(
        $builder->create('description', 'textarea')
            ->addModelTransformer(...)
    );


